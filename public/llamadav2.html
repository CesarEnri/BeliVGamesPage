<!DOCTYPE html>
<html>
<head>
    <title>WebRTC Group Call</title>
</head>
<body>
    <video id="localVideo" autoplay muted></video>
    <video id="remoteVideo" autoplay></video>
    <script>
        const signalingServerUrl = 'wss:///turbo-eureka-6v4vgrg4jxpc4v7x-8080.app.github.dev/ws';
        const peerConnections = {};
        const localStream = null;

        const ws = new WebSocket(signalingServerUrl);

        ws.onmessage = (message) => {
            const data = JSON.parse(message.data);

            if (data.offer) {
                handleOffer(data.offer, data.from);
            } else if (data.answer) {
                handleAnswer(data.answer, data.from);
            } else if (data.iceCandidate) {
                handleIceCandidate(data.iceCandidate, data.from);
            }
        };

        ws.onopen = () => {
            navigator.mediaDevices.getUserMedia({ video: true, audio: true })
                .then(stream => {
                    document.getElementById('localVideo').srcObject = stream;
                    localStream = stream;

                    // Broadcast a new user joining the call
                    ws.send(JSON.stringify({ type: 'newUser' }));
                })
                .catch(error => console.error('Error accessing media devices.', error));
        };

        function handleOffer(offer, from) {
            const pc = new RTCPeerConnection();
            peerConnections[from] = pc;

            localStream.getTracks().forEach(track => {
                pc.addTrack(track, localStream);
            });

            pc.ontrack = (event) => {
                document.getElementById('remoteVideo').srcObject = event.streams[0];
            };

            pc.onicecandidate = (event) => {
                if (event.candidate) {
                    ws.send(JSON.stringify({
                        iceCandidate: event.candidate,
                        to: from
                    }));
                }
            };

            pc.setRemoteDescription(new RTCSessionDescription(offer))
                .then(() => pc.createAnswer())
                .then(answer => pc.setLocalDescription(answer))
                .then(() => {
                    ws.send(JSON.stringify({
                        answer: pc.localDescription,
                        to: from
                    }));
                });
        }

        function handleAnswer(answer, from) {
            peerConnections[from].setRemoteDescription(new RTCSessionDescription(answer));
        }

        function handleIceCandidate(candidate, from) {
            peerConnections[from].addIceCandidate(new RTCIceCandidate(candidate));
        }
    </script>
</body>
</html>
